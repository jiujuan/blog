## 前言

在互联网软件开发中，高并发架构代表着用户多，大流量。比如淘宝、天猫购物网站、京东购物网站、抖音短视频等产品。

还有天猫双十一活动，京东168抢购活动，这2个购物活动都是瞬时高并发系统。它们都是业务复杂度高、链路长、数据量大的系统。

这些系统都是在一个很短的时间内会遇到大量请求情况，系统怎么处理这些请求？怎么设计系统？

设计一个高并发架构系统，需要遵循什么原则？需要用到哪些技术？下面做一个解答。

## 高并发架构一般指导原则

设计高并发系统一般指导原则。

### 分而治之

把一个大的应用系统拆分为多个较小的应用系统，把大数据量的库和表拆分为多个库、多个表。这些都是分而治之的思想。

- **垂直拆分**

**应用系统垂直拆分**：可以按照业务功能进行系统拆分，拆分为多个独立的应用。把一个大的应用系统拆分为多个系统，比如大电商系统，可以拆分为商家系统，前台商品和购物系统，后台系统管理系统。

如果再把上面拆分后的应用系统按照微服务进行拆分，进一步拆分为用户、订单、商品等相互独立的微服务，不同团队负责不同服务系统。

**数据库垂直拆分**：将一个包含所有表的单库，拆分为多个库（如订单库、用户库）。订单表归属订单库，用户表归属用户库。

- **水平拆分**

水平拆分一般是按照数据规则进行拆分，解决单库/单表数据量巨大，读写性能瓶颈的问题。

水平分库分表，将海量数据（如亿级订单数据）按照主键ID范围、用户ID取模等规则，分散到多个结构相同的数据库/表中（如 order_0, order_1...）。

### 无状态化

应用服务器不保存会话状态，以便随时水平扩展（Scale Out）。

可以把状态信息（如 session 信息）保存到外置的分布式缓存中（如 redis）。

### 异步化

利用消息队列来削峰填谷，解耦非核心链路业务。如发短信、积分、日志等。

### 冗余备份和副本

保证高可用。

数据冗余 - 主从复制、多副本。

服务冗余 - 多实例部署。

多机房部署、双活部署、异地部署。

### 最终一致性

在高并发场景下，放弃强一致性，追求高可用和最终一致性。

### 缓存

空间换时间。

构建本地缓存 + 分布式缓存 + CDN的多级缓存体系。

 ## 硬件和操作系统

### 硬件层

高并发系统的是在有限的资源（CPU、内存、磁盘、网络）下，榨取出极致的吞吐量和极低的延迟。

在硬件层面，CPU的多核架构（如SMP、NUMA）、多级缓存（L1/L2/L3）和内存带宽直接影响并行处理能力。

**多核/多 CPU 与并行**

- 核数与线程数

CPU 内部封装一个或多个物理核，只有1个物理核心就是单核 CPU，有多个物理核心就是多核 CPU。

物理 core 核数，硬件线程（超线程），并行度上由硬件线程数决定。

超线程技术（全名为Hyper-Threading）：这种使 CPU 处理器中的 1 颗物理核，如同 2 颗物理核那样发挥作用，从而提高了系统的整体性能。但肯定不会真的像 2 颗物理核那样，而是借助于某些技术将 1 颗物理核的性能发挥更好而已。



- SMP / NUMA / MPP 架构

SMP（Symmetric Multi-Processor）对称多处理器结构， 这中结构指多个 CPU 对称平等，共享相同的物理内存、IO 等资源。因此 SMP结构属于一致存储器访问结构 UMA。早期/小规模服务器常见。

NUMA（Non-Uniform Memory Access）非一致存储访问结构，此架构是服务器有多个 CPU 模块，每个 CPU 模块由多个 CPU 组成，每个 CPU 模块具有独立的本地内存，IO 等资源，CPU 模块也称为 Node。因此访问延迟不同，CPU 访问本地内存比访问远端内存快；跨 NUMA node 访问内存慢，是现代多路服务器的主流架构。

高并发场景下，需进行 NUMA 绑定，让进程/线程尽量在分配内存的 CPU 核心上运行，避免跨 CPU 交互导致延迟飙升。



MPP（Massive Parallel Processing），它是另外一种扩展方式，它由多个 SMP 服务器通过一定的节点网络进行连接，完成相同的任务，可以看作是 SMP 的水平扩展。典型的就是刀片服务器，有的说 MPP 架构很像 MapReduce 模式。



## 参考

- [《大型网站技术架构：核心原理与案例分析》](https://book.douban.com/subject/25723064/ ) 李智慧

- [《亿级流量网站架构核心技术》](https://book.douban.com/subject/26999243/) 张开涛

  